---
layout: post
title:  "16-(3) í˜„ì¡´í•˜ëŠ” AI ì›¹/ì•±ì„œë¹„ìŠ¤ë¥¼ í•˜ë‚˜ ì„ ì •í•˜ì„¸ìš”. (ê°€ìƒì˜ ì„œë¹„ìŠ¤ë¡œ í•´ë³´ëŠ” ê²ƒë„ ì¢‹ì•„ìš”.) ê·¸ ì„œë¹„ìŠ¤ê°€ ì§€ê¸ˆê¹Œì§€ í•™ìŠµí•œ Docker, ì¶”ë¡  ìµœì í™”, Streamlit, FastAPIë¡œ êµ¬í˜„ë˜ì—ˆë‹¤ê³  ê°€ì •í•˜ê³ , ì „ì²´ ì•„í‚¤í…ì²˜ë¥¼ ìž‘ì„±í•´ë³´ì„¸ìš”. ë§Œì•½ ê°€ëŠ¥í•˜ë‹¤ë©´, ë³´ì•ˆ ìš”ì†Œ(CORS ë“±)/ë©€í‹°ìœ ì € ìš”ì²­ ì²˜ë¦¬ ë°©ì•ˆ(ë¹„ë™ê¸° ì²˜ë¦¬, ëŒ€ê¸° í ë“±)/í´ë¼ìš°ë“œ ë°°í¬ êµ¬ì¡°(GCP, AWS)/ëª¨ë‹ˆí„°ë§ ë° ë¡œê¹… ì „ëžµ ê¹Œì§€ í¬í•¨í•˜ì—¬ ìž‘ì„±í•´ë³´ì„¸ìš”."
date:   2025-10-27 02:00:00 +0900
categories: [Quantization]
tags: [Docker,Streamlit, FastAPI, Deep Learning, AI]
comments: true     # ëŒ“ê¸€ ê¸°ëŠ¥ ì‚¬ìš© (ì˜µì…˜)
# image:
#     path: https://images.velog.io/images/iuliet716/post/d2493856-7888-488b-86ad-4706406a02f7/Docker-Logo-White-RGB_Vertical-BG_0-1.png

---
## ðŸŸ¢ ê°€ìƒì˜ ì„œë¹„ìŠ¤ í•˜ë‚˜ë¥¼ ê³¨ë¼ì„œ Streamlit + FastAPI + Triton ê¸°ë°˜ìœ¼ë¡œ ì „ì²´ ì•„í‚¤í…ì²˜ë¥¼ ì„¤ê³„í•´ë³´ìž.
---

### âšª 1. ê°€ìƒ ì„œë¹„ìŠ¤ ì •ì˜: "QSM-AI"

ë³¸ ì•„í‚¤í…ì²˜ ì„¤ê³„ëŠ” ê°€ìƒì˜ AI ì„œë¹„ìŠ¤ **"QSM-AI"**ë¥¼ ê¸°ì¤€ìœ¼ë¡œ í•œë‹¤.

* **ê¸°ëŠ¥:** mGRE (multi-echo Gradient Echo) MRIì˜ Phase(`.nii`) íŒŒì¼ì„ ì—…ë¡œë“œí•˜ë©´, ë”¥ëŸ¬ë‹ ëª¨ë¸(e.g., QSM-ViT)ì´ ì´ë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ QSM (Quantitative Susceptibility Map) ì˜ìƒìœ¼ë¡œ ìž¬êµ¬ì„±í•˜ëŠ” ì›¹ ì„œë¹„ìŠ¤.
* **í•µì‹¬ ìš”êµ¬ ê¸°ìˆ :** `Streamlit`(UI), `FastAPI`(Logic), `Triton`(Inference), `Docker`(Packaging)

### âšª 2. í•µì‹¬ ì•„í‚¤í…ì²˜: 3-Tier Decoupled Microservices

ê°€ìž¥ íš¨ìœ¨ì ì´ê³  í™•ìž¥ ê°€ëŠ¥í•œ êµ¬ì¡°ëŠ” ê° ì»´í¬ë„ŒíŠ¸ì˜ ì—­í• ì„ ëª…í™•ížˆ ë¶„ë¦¬(Decouple)í•˜ëŠ” **3-Tier ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ì•„í‚¤í…ì²˜**ì´ë‹¤.

* **Tier 1: `streamlit-fe` (Frontend):** ì‚¬ìš©ìž UI
* **Tier 2: `fastapi-be` (Backend):** API Gateway, ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§, ì „/í›„ì²˜ë¦¬
* **Tier 3: `triton-is` (Inference):** ê³ ì„±ëŠ¥ AI ëª¨ë¸ ì¶”ë¡ 



ì´ ì„¸ ì„œë¹„ìŠ¤ëŠ” ê°ê° ë³„ë„ì˜ **Docker ì»¨í…Œì´ë„ˆ**ë¡œ ì‹¤í–‰ë˜ë©°, `docker-compose`ë‚˜ `Kubernetes` í™˜ê²½ì˜ **ë‚´ë¶€ ì‚¬ì„¤ ë„¤íŠ¸ì›Œí¬**ë¥¼ í†µí•´ í†µì‹ í•œë‹¤.

### Tier 1: Frontend (Streamlit-FE)
* **ì—­í• :** ì‚¬ìš©ìž ì¸í„°íŽ˜ì´ìŠ¤ ë° ìƒí˜¸ìž‘ìš©.
* **ê¸°ìˆ :** `Streamlit`
* **ë™ìž‘:**
    1.  `st.file_uploader`ë¡œ `.nii` íŒŒì¼ ìˆ˜ì‹ .
    2.  `httpx` ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ìš©í•˜ì—¬ `fastapi-be`ì˜ API ì—”ë“œí¬ì¸íŠ¸(`http://fastapi-be:8000/api/v1/reconstruct`)ë¡œ HTTP `POST` ìš”ì²­.
    3.  `fastapi-be`ë¡œë¶€í„° ê²°ê³¼ íŒŒì¼(e.g., PNG ìŠ¬ë¼ì´ìŠ¤)ì„ ë°›ì•„ `st.image`ë¡œ ì‹œê°í™”.

### Tier 2: Backend (FastAPI-BE / API Gateway)
* **ì—­í• :** ì‹œìŠ¤í…œì˜ 'ë‡Œ' ì—­í• . ë‹¨ìˆœí•œ í”„ë¡ì‹œê°€ ì•„ë‹Œ, í•µì‹¬ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ì²˜ë¦¬.
* **ê¸°ìˆ :** `FastAPI` (CPU ê¸°ë°˜ ì»¨í…Œì´ë„ˆ)
* **ë™ìž‘:**
    1.  **CORS ì„¤ì •:** `Streamlit` ë„ë©”ì¸ìœ¼ë¡œë¶€í„°ì˜ êµì°¨ ì¶œì²˜ ìš”ì²­ì„ í—ˆìš©.
    2.  **API ìˆ˜ì‹  ë° ê²€ì¦:** `/api/v1/reconstruct` ì—”ë“œí¬ì¸íŠ¸ì—ì„œ ìš”ì²­ ìˆ˜ì‹  ë° ìœ íš¨ì„± ê²€ì‚¬.
    3.  **ì „ì²˜ë¦¬ (Pre-processing):** `nibabel`, `numpy` ë“±ì„ ì‚¬ìš©í•˜ì—¬ ì›ë³¸ `.nii` íŒŒì¼ì„ Tritonì´ ìš”êµ¬í•˜ëŠ” Tensor í¬ë§·ìœ¼ë¡œ ë³€í™˜ (e.g., ì •ê·œí™”, ë¦¬ì‚¬ì´ì§•).
    4.  **ì¶”ë¡  ìš”ì²­ (Async):** `FastAPI`ì˜ `async def` ë‚´ì—ì„œ `tritonclient`ì˜ ë¹„ë™ê¸° API (`async_infer`)ë¥¼ í˜¸ì¶œí•˜ì—¬ `triton-is`ì— ì¶”ë¡  ìš”ì²­. (I/O Blocking ë°©ì§€)
    5.  **í›„ì²˜ë¦¬ (Post-processing):** `triton-is`ë¡œë¶€í„° ë°›ì€ Raw Tensorë¥¼ ì‚¬ìš©ìž ì¹œí™”ì ì¸ í¬ë§·(e.g., PNG ìŠ¬ë¼ì´ìŠ¤, `.nii` íŒŒì¼)ìœ¼ë¡œ ë³€í™˜.
    6.  **(Optional) ë¡œê¹… ë° ì €ìž¥:** ìš”ì²­/ì‘ë‹µ ê²°ê³¼ ë° ë©”íƒ€ë°ì´í„°ë¥¼ DBë‚˜ S3ì— ì €ìž¥.
    7.  **ì‘ë‹µ:** `Streamlit-FE`ì— ìµœì¢… ê²°ê³¼ë¬¼(JSON ë˜ëŠ” íŒŒì¼) ë°˜í™˜.

### Tier 3: Inference Server (Triton-IS)
* **ì—­í• :** AI ëª¨ë¸ì˜ ê³ ì„±ëŠ¥ ì—°ì‚°(ì¶”ë¡ )ì„ ì „ë‹´í•˜ëŠ” 'ê·¼ìœ¡'.
* **ê¸°ìˆ :** `NVIDIA Triton Inference Server` (GPU ê¸°ë°˜ ì»¨í…Œì´ë„ˆ)
* **ë™ìž‘:**
    1.  **ëª¨ë¸ ìµœì í™”:** `PyTorch` ëª¨ë¸ì„ `ONNX`ë¡œ ë³€í™˜í•˜ê³ , ë‹¤ì‹œ `TensorRT` ë°±ì—”ë“œë¥¼ ì‚¬ìš©í•˜ì—¬ GPUì— ìµœì í™”ëœ `.plan` ì—”ì§„ íŒŒì¼ë¡œ ë¹Œë“œ.
    2.  **ëª¨ë¸ ë¦¬í¬ì§€í† ë¦¬:** `config.pbtxt` íŒŒì¼ê³¼ ìµœì í™”ëœ ëª¨ë¸ íŒŒì¼(`model.plan`)ì„ `model_repository`ì— ì €ìž¥.
    3.  **ì„œë¹™:** Triton ì„œë²„ê°€ ì´ ë¦¬í¬ì§€í† ë¦¬ë¥¼ ë¡œë“œí•˜ì—¬ GPU ë©”ëª¨ë¦¬ì— ìƒì£¼ì‹œí‚¨ í›„, gRPC(8001) ë° HTTP(8000) í¬íŠ¸ë¥¼ ì—´ê³  ëŒ€ê¸°.
    4.  **ê³ ì„±ëŠ¥ ì¶”ë¡ :** `fastapi-be`ì˜ ìš”ì²­ì„ ë°›ì•„ **Dynamic Batching** ë“±ì˜ ìµœì í™” ê¸°ë²•ì„ ì ìš©í•˜ì—¬ GPUì—ì„œ ì´ˆê³ ì† ì¶”ë¡  ìˆ˜í–‰.

### âšª 3. ìƒì„¸ ì„¤ê³„: ê³ ê¸‰ ê³ ë ¤ì‚¬í•­

### A. ë³´ì•ˆ (Security) - CORS
`fastapi-be`ëŠ” `Streamlit` ì»¨í…Œì´ë„ˆì˜ ë‚´ë¶€ ì£¼ì†Œ(e.g., `http://streamlit-fe:8501`)ì™€ ì‹¤ì œ ë°°í¬ ë„ë©”ì¸(e.g., `https://qsm-ai.com`)ì„ `FastAPI`ì˜ `CORSMiddleware`ì— `allow_origins`ë¡œ ëª…ì‹œí•´ì•¼ í•œë‹¤.

### B. ë©€í‹°ìœ ì € ìš”ì²­ ì²˜ë¦¬ (Concurrency)
ì´ ì•„í‚¤í…ì²˜ëŠ” ë‘ ê°€ì§€ ë ˆë²¨ì—ì„œ ë™ì‹œì„±ì„ ì²˜ë¦¬í•œë‹¤.

1.  **FastAPI (I/O Concurrency):** `async/await`ë¥¼ í†µí•´ ìˆ˜ì‹­ ëª…ì˜ ì‚¬ìš©ìžê°€ ë™ì‹œì— íŒŒì¼ ì—…ë¡œë“œ/ë‹¤ìš´ë¡œë“œë¥¼ ëŒ€ê¸°í•˜ëŠ” I/O ìž‘ì—…ì„ ë¸”ë¡œí‚¹ ì—†ì´ íš¨ìœ¨ì ìœ¼ë¡œ ì²˜ë¦¬í•œë‹¤.
2.  **Triton (Compute Concurrency):** `FastAPI`ë¡œë¶€í„° ë™ì‹œì— ìŸì•„ì§€ëŠ” ì—¬ëŸ¬ ì¶”ë¡  ìš”ì²­ì„ **ìš”ì²­ í(Queue)**ì— ìŒ“ëŠ”ë‹¤. Tritonì˜ **Dynamic Batching** ê¸°ëŠ¥ì´ ì´ íì˜ ìš”ì²­ë“¤ì„ ìµœì ì˜ ë°°ì¹˜ í¬ê¸°(e.g., 8, 16)ë¡œ ë¬¶ì–´ GPUì— í•œ ë²ˆì— ì „ë‹¬í•¨ìœ¼ë¡œì¨, GPUì˜ Throughput(ì²˜ë¦¬ëŸ‰)ì„ ê·¹ëŒ€í™”í•œë‹¤.

### C. í´ë¼ìš°ë“œ ë°°í¬ êµ¬ì¡° (AWS/GCP)
* **ì»´í¬ë„ŒíŠ¸ ë¶„ë¦¬ ë°°í¬:**
    * **Triton (GPU):** `AWS EKS` ë˜ëŠ” `GCP GKE` (Kubernetes)ì˜ **GPU ë…¸ë“œ í’€(Node Pool)** (e.g., `g4dn` ì¸ìŠ¤í„´ìŠ¤)ì— ë°°í¬.
    * **FastAPI & Streamlit (CPU):** `AWS Fargate` ë˜ëŠ” `GCP Cloud Run` ê°™ì€ **ì„œë²„ë¦¬ìŠ¤ ì»¨í…Œì´ë„ˆ** í”Œëž«í¼ì— ë°°í¬í•˜ì—¬ ë¹„ìš© íš¨ìœ¨ì„± ë° ìžë™ í™•ìž¥(Auto-scaling) í™•ë³´.
* **ì¸í”„ë¼:**
    * **Gateway:** `AWS API Gateway` ë˜ëŠ” `Application Load Balancer`ë¥¼ ì‹œìŠ¤í…œ ë§¨ ì•žì— ë°°ì¹˜í•˜ì—¬ `/api/*` ìš”ì²­ì€ `FastAPI`ë¡œ, `/` ìš”ì²­ì€ `Streamlit`ìœ¼ë¡œ ë¼ìš°íŒ….
    * **Storage:** ëª¨ë“  `.nii` íŒŒì¼ ë° ê²°ê³¼ë¬¼ì€ `AWS S3` ë˜ëŠ” `GCP Cloud Storage`ì— ì €ìž¥. ì»¨í…Œì´ë„ˆ ë‚´ë¶€(Ephemeral)ì— ì €ìž¥í•˜ë©´ ì•ˆ ë¨.

### D. ëª¨ë‹ˆí„°ë§ ë° ë¡œê¹… (Observability)
* **Logging:** ëª¨ë“  ì»¨í…Œì´ë„ˆëŠ” `stdout/stderr`ë¡œ ë¡œê·¸ë¥¼ ì¶œë ¥. `AWS CloudWatch Logs` ë˜ëŠ” `GCP Cloud Logging` (Fluentd/Fluentbit)ì„ í†µí•´ ë¡œê·¸ë¥¼ ì¤‘ì•™ ìˆ˜ì§‘.
* **Monitoring (Metrics):**
    * **Triton:** `/metrics` ì—”ë“œí¬ì¸íŠ¸ë¥¼ `Prometheus`ë¡œ ìŠ¤í¬ëž˜í•‘í•˜ì—¬ **GPU ì‚¬ìš©ë¥ , ì¶”ë¡  Latency(P95/P99), ì²˜ë¦¬ëŸ‰(RPS)** ë“± í•µì‹¬ AI ì„±ëŠ¥ ì§€í‘œ í™•ë³´.
    * **FastAPI:** `starlette-prometheus`ë¥¼ ì´ìš©í•´ **API ì—ëŸ¬ìœ¨, ìš”ì²­ Latency** ì§€í‘œ ë…¸ì¶œ.
* **Dashboard & Alerting:** `Grafana` ë˜ëŠ” `AWS CloudWatch Dashboard`ì—ì„œ ìƒê¸° ì§€í‘œë¥¼ ì‹œê°í™”. "P99 Latency > 3ì´ˆ" ë˜ëŠ” "GPU ì‚¬ìš©ë¥  95% ì§€ì†" ì‹œ `Slack` ë˜ëŠ” `Email`ë¡œ **ì•Œë¦¼(Alerting)** ì„¤ì •.


## ðŸŸ¢ ì˜ˆì‹œ ë‹µì•ˆ (ì½”ë“œìž‡ ì œê³µ)
>.